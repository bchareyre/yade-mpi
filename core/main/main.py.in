#!/usr/bin/python
# encoding: utf-8
# syntax:python

import sys,os,os.path
# get yade path (allow YADE_PREFIX to override)
prefix,suffix='${PREFIX}' if not os.environ.has_key('YADE_PREFIX') else os.environ('YADE_PREFIX'),'${SUFFIX}'
sys.path.append(os.path.join(prefix,'lib','yade'+suffix,'py'))

# initialization and c++ plugins import
import yade
# other parts we will need soon
import yade.config
import yade.wrapper
import yade.log


# handle command-line options first
import optparse
par=optparse.OptionParser(usage='%prog [options] [ simulation.xml[.bz2] | script.py [script options]]',prog='Yade',version='%s (%s)'%(yade.config.version,','.join(yade.config.features)))
par.add_option('-j','--threads',help='Number of OpenMP threads to run; defaults to number of cores.',dest='threads',type='int')
par.add_option('-x',help='Exit when the script finishes',dest='exitAfter')
if 'log4cxx' in yade.config.features:
	par.add_option('-v',help='Increase logging verbosity; first occurence sets default logging level to info, second to debug, third to trace.',action='count',dest='verbosity')
if yade.config.debug:
	par.add_option('--no-gdb',help='Do not show backtrace when yade crashes.',dest='noGdb',action='store_true',)

opts,args=par.parse_args()

if opts.threads:
	os.environ['OMP_NUM_THREADS']=str(opts.threads)
if yade.config.debug and opts.noGdb:
	yade.wrapper.Omega().disableGdb()
if 'log4cxx' in yade.config.features and opts.verbosity:
	yade.log.setLevel([yade.log.INFO,yade.log.DEBUG,yade.log.TRACE][min(opts.verbosity,3)])

# open GUI if possible
try:
	import yade.qt
	yade.qt.Controller()
except ImportError: pass

# be nice to users
from yade import *
from math import *

# something to run?
if len(args)>0:
	if args[0].endswith('.xml') or args[0].endswith('.xml.bz2'):
		if len(args)>1: raise RuntimeError('Extra arguments to XML simulation to run: '+' '.join(args[1:]))
		print "Running simulation "+args[0]
		O=yade.wrapper.Omega(); O.load(args[0]); O.run()
	if args[0].endswith('.py'):
		print "Running script "+args[0]
		yade.runtime.argv=args[1:]
		execfile(args[0])
		if opts.exitAfter: sys.exit(0)

# show python command-line
if 1:
	if 1:
		from IPython.Shell import IPShellEmbed
		ipshell=IPShellEmbed(exit_msg='Bye.',rc_override={'execfile':[prefix+'/lib/yade'+suffix+'/py/yade/ipython.py']})
		ipshell()
	else:
		import bpython
		bpython.embed()
O.exitNoBacktrace()
